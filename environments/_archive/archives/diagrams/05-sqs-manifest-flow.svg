<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1500 1100">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: 16px sans-serif; fill: #666; }
      .box { fill: #fff; stroke: #333; stroke-width: 2; }
      .sqs-box { fill: #FF4F8B; stroke: #cc3f6f; stroke-width: 2; }
      .lambda-box { fill: #FF9900; stroke: #cc7a00; stroke-width: 2; }
      .manifest-box { fill: #9C27B0; stroke: #6a1b9a; stroke-width: 2; }
      .file-box { fill: #569A31; stroke: #3d6e23; stroke-width: 2; }
      .text { font: 14px sans-serif; fill: #fff; text-anchor: middle; }
      .label { font: 13px sans-serif; fill: #333; text-anchor: middle; }
      .small-text { font: 11px sans-serif; fill: #666; }
      .metric-text { font: 10px monospace; fill: #999; }
      .code-text { font: 10px monospace; fill: #333; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .data-arrow { stroke: #0066cc; stroke-width: 3; fill: none; marker-end: url(#data-arrowhead); }
      .section-title { font: bold 16px sans-serif; fill: #1976d2; }
      .highlight { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="data-arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#0066cc" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="750" y="30" class="title" text-anchor="middle">SQS &amp; Manifest Processing Flow</text>
  <text x="750" y="55" class="subtitle" text-anchor="middle">Detailed batching and manifest creation logic</text>

  <!-- SECTION 1: SQS Message Flow -->
  <text x="50" y="100" class="section-title">SECTION 1: SQS Message Processing</text>

  <!-- S3 Events -->
  <rect x="50" y="130" width="180" height="80" class="file-box" rx="5"/>
  <text x="140" y="160" class="text">S3 Events</text>
  <text x="140" y="180" class="metric-text" fill="#fff">338,000 events/day</text>
  <text x="140" y="195" class="metric-text" fill="#fff">ObjectCreated:Put</text>

  <!-- SQS Queue Detail -->
  <rect x="280" y="120" width="300" height="200" class="sqs-box" rx="5"/>
  <text x="430" y="150" class="text">SQS: file-events Queue</text>

  <text x="290" y="180" class="small-text" fill="#fff" text-anchor="start">Configuration:</text>
  <text x="300" y="200" class="metric-text" fill="#fff" text-anchor="start">• Visibility Timeout: 300 seconds</text>
  <text x="300" y="215" class="metric-text" fill="#fff" text-anchor="start">• Max Message Size: 256 KB</text>
  <text x="300" y="230" class="metric-text" fill="#fff" text-anchor="start">• Retention: 4 days</text>
  <text x="300" y="245" class="metric-text" fill="#fff" text-anchor="start">• DLQ: Yes (after 3 failures)</text>

  <text x="290" y="270" class="small-text" fill="#fff" text-anchor="start">Message Format:</text>
  <text x="300" y="290" class="metric-text" fill="#fff" text-anchor="start">{</text>
  <text x="310" y="305" class="metric-text" fill="#fff" text-anchor="start">"bucket": "ndjson-input-*",</text>
  <text x="310" y="320" class="metric-text" fill="#fff" text-anchor="start">"key": "2025-12-24/file.ndjson"</text>
  <text x="300" y="335" class="metric-text" fill="#fff" text-anchor="start">}</text>

  <path d="M 230 170 L 280 170" class="data-arrow"/>
  <text x="255" y="165" class="small-text">Send event</text>

  <!-- Lambda Polling -->
  <rect x="630" y="130" width="200" height="180" class="lambda-box" rx="5"/>
  <text x="730" y="160" class="text">Lambda Polling</text>

  <text x="640" y="190" class="small-text" fill="#fff" text-anchor="start">Trigger:</text>
  <text x="650" y="210" class="metric-text" fill="#fff" text-anchor="start">• EventBridge: Every 1 min</text>
  <text x="650" y="225" class="metric-text" fill="#fff" text-anchor="start">• OR SQS event source mapping</text>

  <text x="640" y="250" class="small-text" fill="#fff" text-anchor="start">Batch Settings:</text>
  <text x="650" y="270" class="metric-text" fill="#fff" text-anchor="start">• Batch Size: 10 messages</text>
  <text x="650" y="285" class="metric-text" fill="#fff" text-anchor="start">• Wait Time: 20 seconds (long poll)</text>
  <text x="650" y="300" class="metric-text" fill="#fff" text-anchor="start">• Concurrency: 5-10 instances</text>

  <path d="M 580 220 L 630 220" class="arrow"/>
  <text x="605" y="215" class="small-text">Poll</text>
  <text x="605" y="230" class="small-text">(batch=10)</text>

  <!-- Message Processing Box -->
  <rect x="50" y="360" width="780" height="140" class="highlight" rx="5"/>
  <text x="60" y="385" class="label" text-anchor="start" style="font-weight: bold;">Message Processing Logic (per batch of 10)</text>

  <text x="70" y="410" class="code-text" text-anchor="start">for message in batch:</text>
  <text x="90" y="425" class="code-text" text-anchor="start">1. Extract: bucket, key, size</text>
  <text x="90" y="440" class="code-text" text-anchor="start">2. Validate: size between 2.8-4.2 GB?</text>
  <text x="100" y="455" class="code-text" text-anchor="start">IF valid:</text>
  <text x="120" y="470" class="code-text" text-anchor="start">→ DynamoDB.PutItem({status: "pending"})</text>
  <text x="100" y="485" class="code-text" text-anchor="start">ELSE:</text>
  <text x="120" y="500" class="code-text" text-anchor="start">→ S3.CopyObject(quarantine_bucket)</text>

  <!-- SECTION 2: Batching Logic -->
  <text x="50" y="560" class="section-title">SECTION 2: File-Count Batching Logic</text>

  <!-- Query Pending Files -->
  <rect x="50" y="590" width="250" height="120" class="lambda-box" rx="5"/>
  <text x="175" y="620" class="text">Query Pending Files</text>

  <text x="60" y="650" class="metric-text" fill="#fff" text-anchor="start">DynamoDB Query:</text>
  <text x="70" y="670" class="code-text" fill="#fff" text-anchor="start">WHERE date_prefix = TODAY</text>
  <text x="70" y="685" class="code-text" fill="#fff" text-anchor="start">AND status = 'pending'</text>
  <text x="70" y="700" class="code-text" fill="#fff" text-anchor="start">ORDER BY upload_time ASC</text>

  <!-- Batching Decision -->
  <polygon points="420,590 520,640 420,690 320,640" class="highlight"/>
  <text x="420" y="635" class="label">Count >= 100?</text>
  <text x="420" y="655" class="small-text">(file-count)</text>

  <path d="M 300 650 L 320 640" class="arrow"/>

  <!-- Wait Path -->
  <rect x="540" y="560" width="180" height="80" class="box" rx="5"/>
  <text x="630" y="590" class="label">Wait</text>
  <text x="630" y="610" class="small-text">Check again in 1 min</text>
  <text x="630" y="625" class="small-text">Files accumulate</text>

  <path d="M 520 640 L 540 600" class="arrow"/>
  <text x="530" y="615" class="small-text">No</text>

  <path d="M 630 560 L 630 530 L 175 530 L 175 590" class="arrow"/>

  <!-- Create Manifest Path -->
  <rect x="540" y="660" width="180" height="80" class="manifest-box" rx="5"/>
  <text x="630" y="690" class="text">Create Manifest</text>
  <text x="630" y="710" class="small-text" fill="#fff">100 files ready!</text>
  <text x="630" y="725" class="small-text" fill="#fff">→ Build JSON</text>

  <path d="M 520 640 L 540 700" class="arrow"/>
  <text x="530" y="675" class="small-text">Yes</text>

  <!-- SECTION 3: Manifest Structure -->
  <text x="50" y="790" class="section-title">SECTION 3: Manifest JSON Structure</text>

  <!-- Manifest JSON Example -->
  <rect x="50" y="820" width="700" height="250" class="box" rx="5" style="fill: #f5f5f5;"/>
  <text x="60" y="845" class="code-text" text-anchor="start" style="font-weight: bold;">Manifest JSON (manifest-001.json):</text>

  <text x="70" y="870" class="code-text" text-anchor="start">{</text>
  <text x="90" y="885" class="code-text" text-anchor="start">"fileLocations": [</text>
  <text x="110" y="900" class="code-text" text-anchor="start">{</text>
  <text x="130" y="915" class="code-text" text-anchor="start">"URIPrefixes": [</text>
  <text x="150" y="930" class="code-text" text-anchor="start">"s3://ndjson-input-sqs-<ACCOUNT>/2025-12-24/file-001.ndjson",</text>
  <text x="150" y="945" class="code-text" text-anchor="start">"s3://ndjson-input-sqs-<ACCOUNT>/2025-12-24/file-002.ndjson",</text>
  <text x="150" y="960" class="code-text" text-anchor="start">"s3://ndjson-input-sqs-<ACCOUNT>/2025-12-24/file-003.ndjson",</text>
  <text x="150" y="975" class="code-text" text-anchor="start">...</text>
  <text x="150" y="990" class="code-text" text-anchor="start">"s3://ndjson-input-sqs-<ACCOUNT>/2025-12-24/file-100.ndjson"</text>
  <text x="130" y="1005" class="code-text" text-anchor="start">]</text>
  <text x="110" y="1020" class="code-text" text-anchor="start">}</text>
  <text x="90" y="1035" class="code-text" text-anchor="start">],</text>
  <text x="90" y="1050" class="code-text" text-anchor="start">"created_at": "2025-12-24T10:30:00Z",</text>
  <text x="90" y="1065" class="code-text" text-anchor="start">"total_files": 100</text>
  <text x="70" y="1080" class="code-text" text-anchor="start">}</text>

  <!-- Manifest Metrics -->
  <rect x="790" y="820" width="350" height="250" class="box" rx="5" style="fill: #e8f5e9;"/>
  <text x="800" y="845" class="label" text-anchor="start" style="font-weight: bold;">Manifest Metrics</text>

  <text x="800" y="875" class="small-text" text-anchor="start">Per Manifest:</text>
  <text x="810" y="895" class="metric-text" text-anchor="start">• Files: 100</text>
  <text x="810" y="910" class="metric-text" text-anchor="start">• Total Size: ~400 GB (100 × 4GB avg)</text>
  <text x="810" y="925" class="metric-text" text-anchor="start">• Records: ~2.1 billion</text>
  <text x="810" y="940" class="metric-text" text-anchor="start">• Manifest Size: ~50 KB</text>
  <text x="810" y="955" class="metric-text" text-anchor="start">• Processing Time: 7-10 minutes</text>

  <text x="800" y="980" class="small-text" text-anchor="start">Daily Production (338K files):</text>
  <text x="810" y="1000" class="metric-text" text-anchor="start">• Manifests Created: 3,380</text>
  <text x="810" y="1015" class="metric-text" text-anchor="start">• Total Data: 1.3 PB</text>
  <text x="810" y="1030" class="metric-text" text-anchor="start">• Glue Jobs: 3,380 (30 concurrent)</text>
  <text x="810" y="1045" class="metric-text" text-anchor="start">• Total Time: 9-15 hours</text>
  <text x="810" y="1060" class="metric-text" text-anchor="start">• Cost: $2,500-$3,500/day</text>

  <!-- SECTION 4: Key Configuration -->
  <rect x="1180" y="130" width="280" height="380" class="box" rx="5" style="fill: #fff3e0;"/>
  <text x="1190" y="160" class="section-title">Key Configuration</text>

  <text x="1190" y="190" class="label" text-anchor="start" style="font-weight: bold;">Lambda Environment:</text>
  <text x="1200" y="210" class="metric-text" text-anchor="start">MAX_FILES_PER_MANIFEST=100</text>
  <text x="1200" y="225" class="metric-text" text-anchor="start">MAX_BATCH_SIZE_GB=500</text>
  <text x="1200" y="240" class="metric-text" text-anchor="start">EXPECTED_FILE_SIZE_MB=3500</text>
  <text x="1200" y="255" class="metric-text" text-anchor="start">SIZE_TOLERANCE_PERCENT=20</text>

  <text x="1190" y="285" class="label" text-anchor="start" style="font-weight: bold;">SQS Configuration:</text>
  <text x="1200" y="305" class="metric-text" text-anchor="start">VisibilityTimeout: 300 sec</text>
  <text x="1200" y="320" class="metric-text" text-anchor="start">MessageRetentionPeriod: 345600 sec</text>
  <text x="1200" y="335" class="metric-text" text-anchor="start">ReceiveMessageWaitTime: 20 sec</text>

  <text x="1190" y="365" class="label" text-anchor="start" style="font-weight: bold;">Glue Trigger:</text>
  <text x="1200" y="385" class="metric-text" text-anchor="start">Mode: Batch (glueetl)</text>
  <text x="1200" y="400" class="metric-text" text-anchor="start">MaxConcurrentRuns: 30</text>
  <text x="1200" y="415" class="metric-text" text-anchor="start">Workers: 20 × G.2X</text>
  <text x="1200" y="430" class="metric-text" text-anchor="start">Timeout: 120 minutes</text>

  <text x="1190" y="460" class="label" text-anchor="start" style="font-weight: bold;">Why File-Count Batching?</text>
  <text x="1200" y="480" class="small-text" text-anchor="start">✓ Predictable batch sizes</text>
  <text x="1200" y="495" class="small-text" text-anchor="start">✓ Optimal for large files (3-4GB)</text>
  <text x="1200" y="510" class="small-text" text-anchor="start">✓ Better parallelization</text>

  <!-- Flow Summary -->
  <rect x="1180" y="540" width="280" height="160" class="box" rx="5" style="fill: #e3f2fd;"/>
  <text x="1190" y="565" class="label" text-anchor="start" style="font-weight: bold;">Processing Flow Summary</text>

  <text x="1200" y="590" class="small-text" text-anchor="start">1. Files upload → SQS events</text>
  <text x="1200" y="605" class="small-text" text-anchor="start">2. Lambda polls (10 msgs/batch)</text>
  <text x="1200" y="620" class="small-text" text-anchor="start">3. Validate &amp; track in DynamoDB</text>
  <text x="1200" y="635" class="small-text" text-anchor="start">4. Query pending (wait for 100)</text>
  <text x="1200" y="650" class="small-text" text-anchor="start">5. Create manifest JSON</text>
  <text x="1200" y="665" class="small-text" text-anchor="start">6. Trigger Glue job</text>
  <text x="1200" y="680" class="small-text" text-anchor="start">7. Process 100 files in parallel</text>
  <text x="1200" y="695" class="small-text" text-anchor="start">8. Update status: completed</text>

</svg>
