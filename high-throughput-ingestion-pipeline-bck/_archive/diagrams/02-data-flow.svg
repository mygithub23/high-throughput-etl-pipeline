<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1000">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: 16px sans-serif; fill: #666; }
      .box { fill: #fff; stroke: #333; stroke-width: 2; }
      .process-box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; }
      .storage-box { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; }
      .decision-box { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .text { font: 13px sans-serif; fill: #333; text-anchor: middle; }
      .small-text { font: 11px sans-serif; fill: #666; }
      .metric-text { font: 10px monospace; fill: #999; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .thick-arrow { stroke: #0066cc; stroke-width: 4; fill: none; marker-end: url(#thick-arrowhead); }
      .step-number { font: bold 16px sans-serif; fill: #fff; }
      .step-circle { fill: #1976d2; stroke: #0d47a1; stroke-width: 2; }
      .stage-label { font: bold 14px sans-serif; fill: #1976d2; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="thick-arrowhead" markerWidth="12" markerHeight="12" refX="10" refY="3" orient="auto">
      <polygon points="0 0, 12 3, 0 6" fill="#0066cc" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="800" y="30" class="title" text-anchor="middle">Data Flow Diagram - NDJSON to Parquet Pipeline</text>
  <text x="800" y="55" class="subtitle" text-anchor="middle">End-to-End Processing Flow with Data Transformations</text>

  <!-- STAGE 1: Upload -->
  <text x="80" y="100" class="stage-label">STAGE 1: Upload</text>

  <!-- Step 1 -->
  <circle cx="150" cy="150" r="20" class="step-circle"/>
  <text x="150" y="157" class="step-number">1</text>

  <rect x="50" y="190" width="200" height="120" class="storage-box" rx="5"/>
  <text x="150" y="215" class="text" style="font-weight: bold;">File Upload</text>
  <text x="150" y="235" class="small-text">Source: Data Pipeline</text>
  <text x="150" y="255" class="metric-text">Format: NDJSON (.ndjson)</text>
  <text x="150" y="270" class="metric-text">Size: 3.5-4.5 GB per file</text>
  <text x="150" y="285" class="metric-text">Rate: 14K-50K files/hour</text>
  <text x="150" y="300" class="metric-text">Daily: 338,000 files</text>

  <path d="M 150 180 L 150 190" class="arrow"/>

  <!-- S3 Input -->
  <rect x="50" y="340" width="200" height="100" class="storage-box" rx="5"/>
  <text x="150" y="365" class="text" style="font-weight: bold;">S3: Input Bucket</text>
  <text x="150" y="385" class="small-text">s3://ndjson-input-sqs-*</text>
  <text x="150" y="405" class="metric-text">Storage: Standard</text>
  <text x="150" y="420" class="metric-text">Versioning: Disabled</text>
  <text x="150" y="435" class="metric-text">Lifecycle: 7 days → Delete</text>

  <path d="M 150 310 L 150 340" class="thick-arrow"/>

  <!-- STAGE 2: Event Processing -->
  <text x="80" y="500" class="stage-label">STAGE 2: Event</text>

  <!-- Step 2 -->
  <circle cx="150" cy="550" r="20" class="step-circle"/>
  <text x="150" y="557" class="step-number">2</text>

  <!-- S3 Event Notification -->
  <rect x="50" y="590" width="200" height="80" class="process-box" rx="5"/>
  <text x="150" y="615" class="text" style="font-weight: bold;">S3 Event Notification</text>
  <text x="150" y="635" class="metric-text">Event: ObjectCreated:Put</text>
  <text x="150" y="650" class="metric-text">Payload: Bucket, Key, Size</text>
  <text x="150" y="665" class="metric-text">Destination: SQS Queue</text>

  <path d="M 150 580 L 150 590" class="arrow"/>
  <path d="M 150 440 L 150 550" class="arrow"/>

  <!-- SQS Queue -->
  <rect x="50" y="700" width="200" height="90" class="storage-box" rx="5"/>
  <text x="150" y="725" class="text" style="font-weight: bold;">SQS: Event Queue</text>
  <text x="150" y="745" class="small-text">file-events</text>
  <text x="150" y="765" class="metric-text">Batch Size: 10 messages</text>
  <text x="150" y="780" class="metric-text">Visibility: 300 seconds</text>

  <path d="M 150 670 L 150 700" class="thick-arrow"/>

  <!-- STAGE 3: File Tracking & Batching -->
  <text x="420" y="100" class="stage-label">STAGE 3: Tracking</text>

  <!-- Step 3 -->
  <circle cx="500" cy="150" r="20" class="step-circle"/>
  <text x="500" y="157" class="step-number">3</text>

  <!-- Lambda Triggered -->
  <rect x="400" y="190" width="200" height="100" class="process-box" rx="5"/>
  <text x="500" y="215" class="text" style="font-weight: bold;">Lambda: Poll SQS</text>
  <text x="500" y="235" class="small-text">manifest-builder</text>
  <text x="500" y="255" class="metric-text">Trigger: SQS poll (1 min)</text>
  <text x="500" y="270" class="metric-text">Batch: 10 messages</text>
  <text x="500" y="285" class="metric-text">Timeout: 300 seconds</text>

  <path d="M 250 745 L 350 745 L 350 240 L 400 240" class="arrow"/>
  <text x="300" y="740" class="small-text">Poll queue</text>

  <path d="M 500 180 L 500 190" class="arrow"/>

  <!-- File Validation -->
  <polygon points="500,320 580,360 500,400 420,360" class="decision-box"/>
  <text x="500" y="355" class="text">Validate</text>
  <text x="500" y="370" class="text">File Size?</text>
  <text x="500" y="385" class="small-text">2.8-4.2 GB</text>

  <path d="M 500 290 L 500 320" class="arrow"/>

  <!-- Quarantine -->
  <rect x="680" y="330" width="140" height="60" class="storage-box" rx="5"/>
  <text x="750" y="355" class="text">S3: Quarantine</text>
  <text x="750" y="375" class="small-text">Invalid files</text>

  <path d="M 580 360 L 680 360" class="arrow"/>
  <text x="630" y="355" class="small-text">Invalid</text>

  <!-- DynamoDB Insert -->
  <rect x="400" y="450" width="200" height="110" class="storage-box" rx="5"/>
  <text x="500" y="475" class="text" style="font-weight: bold;">DynamoDB: Track File</text>
  <text x="500" y="495" class="small-text">file-tracking table</text>
  <text x="500" y="515" class="metric-text">PK: date_prefix (2025-12-24)</text>
  <text x="500" y="530" class="metric-text">SK: file_key (path)</text>
  <text x="500" y="545" class="metric-text">Status: pending</text>
  <text x="500" y="560" class="metric-text">Timestamp: upload_time</text>

  <path d="M 500 400 L 500 450" class="arrow"/>
  <text x="510" y="425" class="small-text">Valid</text>

  <!-- STAGE 4: Manifest Creation -->
  <text x="420" y="620" class="stage-label">STAGE 4: Batching</text>

  <!-- Step 4 -->
  <circle cx="500" cy="670" r="20" class="step-circle"/>
  <text x="500" y="677" class="step-number">4</text>

  <!-- Check Batch Size -->
  <rect x="400" y="710" width="200" height="100" class="process-box" rx="5"/>
  <text x="500" y="735" class="text" style="font-weight: bold;">Batch Files</text>
  <text x="500" y="755" class="small-text">File-count batching</text>
  <text x="500" y="775" class="metric-text">Target: 100 files/manifest</text>
  <text x="500" y="790" class="metric-text">Max Size: 500 GB</text>
  <text x="500" y="805" class="metric-text">Query DynamoDB pending</text>

  <path d="M 500 700 L 500 710" class="arrow"/>
  <path d="M 500 560 L 500 670" class="arrow"/>

  <!-- Decision: Enough files? -->
  <polygon points="500,840 580,880 500,920 420,880" class="decision-box"/>
  <text x="500" y="875" class="text">100 Files</text>
  <text x="500" y="890" class="text">Ready?</text>

  <path d="M 500 810 L 500 840" class="arrow"/>

  <!-- Wait path -->
  <path d="M 420 880 L 360 880 L 360 760 L 400 760" class="arrow"/>
  <text x="370" y="875" class="small-text">No - Wait</text>

  <!-- STAGE 5: Manifest Creation -->
  <text x="900" y="100" class="stage-label">STAGE 5: Manifest</text>

  <!-- Step 5 -->
  <circle cx="980" cy="150" r="20" class="step-circle"/>
  <text x="980" y="157" class="step-number">5</text>

  <!-- Create Manifest -->
  <rect x="880" y="190" width="200" height="130" class="process-box" rx="5"/>
  <text x="980" y="215" class="text" style="font-weight: bold;">Create Manifest JSON</text>
  <text x="980" y="240" class="metric-text">fileLocations: [{</text>
  <text x="980" y="255" class="metric-text">  URIPrefixes: [</text>
  <text x="980" y="270" class="metric-text">    "s3://bucket/file1.ndjson",</text>
  <text x="980" y="285" class="metric-text">    ... (100 files)</text>
  <text x="980" y="300" class="metric-text">  ]</text>
  <text x="980" y="315" class="metric-text">}]</text>

  <path d="M 580 880 L 900 880 L 900 250 L 880 250" class="arrow"/>
  <text x="740" y="875" class="small-text">Yes - Create manifest</text>

  <path d="M 980 180 L 980 190" class="arrow"/>

  <!-- S3 Manifest Upload -->
  <rect x="880" y="350" width="200" height="100" class="storage-box" rx="5"/>
  <text x="980" y="375" class="text" style="font-weight: bold;">S3: Manifest Bucket</text>
  <text x="980" y="395" class="small-text">s3://manifests/YYYY-MM-DD/</text>
  <text x="980" y="415" class="metric-text">manifest-001.json</text>
  <text x="980" y="430" class="metric-text">3,380 manifests/day</text>
  <text x="980" y="445" class="metric-text">~50 KB each</text>

  <path d="M 980 320 L 980 350" class="thick-arrow"/>

  <!-- Update DynamoDB -->
  <rect x="880" y="480" width="200" height="90" class="process-box" rx="5"/>
  <text x="980" y="505" class="text" style="font-weight: bold;">Update File Status</text>
  <text x="980" y="530" class="metric-text">Status: pending → manifested</text>
  <text x="980" y="545" class="metric-text">Manifest path: s3://...</text>
  <text x="980" y="560" class="metric-text">Batch ID: uuid</text>

  <path d="M 980 450 L 980 480" class="arrow"/>

  <!-- STAGE 6: Glue Processing -->
  <text x="1260" y="100" class="stage-label">STAGE 6: Transform</text>

  <!-- Step 6 -->
  <circle cx="1340" cy="150" r="20" class="step-circle"/>
  <text x="1340" y="157" class="step-number">6</text>

  <!-- Glue Job Triggered -->
  <rect x="1240" y="190" width="200" height="120" class="process-box" rx="5"/>
  <text x="1340" y="215" class="text" style="font-weight: bold;">Glue Job: Start</text>
  <text x="1340" y="235" class="small-text">streaming-processor</text>
  <text x="1340" y="255" class="metric-text">Mode: glueetl (batch)</text>
  <text x="1340" y="270" class="metric-text">Workers: 20 × G.2X</text>
  <text x="1340" y="285" class="metric-text">Concurrent: 30 jobs</text>
  <text x="1340" y="300" class="metric-text">Timeout: 120 minutes</text>

  <path d="M 1080 400 L 1200 400 L 1200 250 L 1240 250" class="arrow"/>
  <text x="1140" y="395" class="small-text">Trigger job</text>

  <path d="M 1340 180 L 1340 190" class="arrow"/>

  <!-- Data Processing Steps -->
  <rect x="1240" y="340" width="200" height="280" class="process-box" rx="5"/>
  <text x="1340" y="365" class="text" style="font-weight: bold;">PySpark Processing</text>

  <text x="1250" y="390" class="small-text" text-anchor="start">1. Read NDJSON from S3</text>
  <text x="1260" y="405" class="metric-text" text-anchor="start">• 100 files in parallel</text>
  <text x="1260" y="420" class="metric-text" text-anchor="start">• 400 GB total</text>

  <text x="1250" y="445" class="small-text" text-anchor="start">2. Parse JSON</text>
  <text x="1260" y="460" class="metric-text" text-anchor="start">• ~2.1B records</text>
  <text x="1260" y="475" class="metric-text" text-anchor="start">• Schema inference</text>

  <text x="1250" y="500" class="small-text" text-anchor="start">3. Transform Data</text>
  <text x="1260" y="515" class="metric-text" text-anchor="start">• Cast all to string</text>
  <text x="1260" y="530" class="metric-text" text-anchor="start">• Add metadata columns</text>

  <text x="1250" y="555" class="small-text" text-anchor="start">4. Write Parquet</text>
  <text x="1260" y="570" class="metric-text" text-anchor="start">• Snappy compression</text>
  <text x="1260" y="585" class="metric-text" text-anchor="start">• 640 files @ 128MB</text>
  <text x="1260" y="600" class="metric-text" text-anchor="start">• 5-7x compression</text>

  <path d="M 1340 310 L 1340 340" class="arrow"/>

  <!-- STAGE 7: Output -->
  <text x="1260" y="680" class="stage-label">STAGE 7: Output</text>

  <!-- Step 7 -->
  <circle cx="1340" cy="730" r="20" class="step-circle"/>
  <text x="1340" y="737" class="step-number">7</text>

  <!-- S3 Output -->
  <rect x="1240" y="770" width="200" height="110" class="storage-box" rx="5"/>
  <text x="1340" y="795" class="text" style="font-weight: bold;">S3: Output Bucket</text>
  <text x="1340" y="815" class="small-text">s3://output/parquet/YYYY-MM-DD/</text>
  <text x="1340" y="835" class="metric-text">Format: Parquet + Snappy</text>
  <text x="1340" y="850" class="metric-text">Output: 57-80 GB (per manifest)</text>
  <text x="1340" y="865" class="metric-text">Daily: 190-270 TB</text>
  <text x="1340" y="880" class="metric-text">Files: ~2.1M/day @ 128MB</text>

  <path d="M 1340 760 L 1340 770" class="arrow"/>
  <path d="M 1340 620 L 1340 730" class="arrow"/>

  <!-- Update Status -->
  <rect x="1240" y="920" width="200" height="70" class="process-box" rx="5"/>
  <text x="1340" y="945" class="text" style="font-weight: bold;">Update Status</text>
  <text x="1340" y="965" class="metric-text">Status: manifested → completed</text>
  <text x="1340" y="980" class="metric-text">Processing time: 7-10 min</text>

  <path d="M 1340 880 L 1340 920" class="arrow"/>

  <!-- Summary Box -->
  <rect x="20" y="920" width="350" height="70" class="box" rx="5" style="fill: #e8f5e9;"/>
  <text x="195" y="945" class="text" style="font-weight: bold;">Data Transformation Summary</text>
  <text x="195" y="965" class="small-text">Input: 338K files/day @ 4GB NDJSON = 1.3 PB</text>
  <text x="195" y="980" class="small-text">Output: 2.1M files/day @ 128MB Parquet = 190-270 TB (5-7x compression)</text>

</svg>
