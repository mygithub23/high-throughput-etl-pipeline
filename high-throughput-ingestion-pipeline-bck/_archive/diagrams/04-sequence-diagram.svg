<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1400">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: 16px sans-serif; fill: #666; }
      .actor-box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; }
      .lifeline { stroke: #999; stroke-width: 2; stroke-dasharray: 5,5; }
      .activation { fill: #bbdefb; stroke: #1976d2; stroke-width: 2; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return-arrow { stroke: #666; stroke-width: 1.5; fill: none; stroke-dasharray: 5,3; marker-end: url(#return-arrowhead); }
      .async-arrow { stroke: #ff6f00; stroke-width: 2; fill: none; marker-end: url(#async-arrowhead); }
      .text { font: 13px sans-serif; fill: #333; }
      .small-text { font: 11px sans-serif; fill: #666; }
      .step-text { font: bold 12px sans-serif; fill: #1976d2; }
      .note-box { fill: #fff9c4; stroke: #f57f17; stroke-width: 1; }
      .note-text { font: 11px sans-serif; fill: #333; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="return-arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#666" />
    </marker>
    <marker id="async-arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#ff6f00" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="800" y="30" class="title" text-anchor="middle">Sequence Diagram - NDJSON to Parquet Pipeline</text>
  <text x="800" y="55" class="subtitle" text-anchor="middle">Detailed interaction flow between components</text>

  <!-- Actors -->
  <!-- Data Source -->
  <rect x="50" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="110" y="130" class="text" text-anchor="middle" style="font-weight: bold;">Data Source</text>

  <!-- S3 Input -->
  <rect x="230" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="290" y="130" class="text" text-anchor="middle" style="font-weight: bold;">S3 Input</text>

  <!-- SQS -->
  <rect x="410" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="470" y="130" class="text" text-anchor="middle" style="font-weight: bold;">SQS Queue</text>

  <!-- Lambda -->
  <rect x="590" y="100" width="140" height="50" class="actor-box" rx="5"/>
  <text x="660" y="130" class="text" text-anchor="middle" style="font-weight: bold;">Lambda</text>
  <text x="660" y="145" class="small-text" text-anchor="middle">manifest-builder</text>

  <!-- DynamoDB -->
  <rect x="790" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="850" y="130" class="text" text-anchor="middle" style="font-weight: bold;">DynamoDB</text>

  <!-- S3 Manifest -->
  <rect x="970" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="1030" y="130" class="text" text-anchor="middle" style="font-weight: bold;">S3 Manifest</text>

  <!-- Glue -->
  <rect x="1150" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="1210" y="130" class="text" text-anchor="middle" style="font-weight: bold;">Glue Job</text>

  <!-- S3 Output -->
  <rect x="1330" y="100" width="120" height="50" class="actor-box" rx="5"/>
  <text x="1390" y="130" class="text" text-anchor="middle" style="font-weight: bold;">S3 Output</text>

  <!-- Lifelines -->
  <line x1="110" y1="150" x2="110" y2="1350" class="lifeline"/>
  <line x1="290" y1="150" x2="290" y2="1350" class="lifeline"/>
  <line x1="470" y1="150" x2="470" y2="1350" class="lifeline"/>
  <line x1="660" y1="150" x2="660" y2="1350" class="lifeline"/>
  <line x1="850" y1="150" x2="850" y2="1350" class="lifeline"/>
  <line x1="1030" y1="150" x2="1030" y2="1350" class="lifeline"/>
  <line x1="1210" y1="150" x2="1210" y2="1350" class="lifeline"/>
  <line x1="1390" y1="150" x2="1390" y2="1350" class="lifeline"/>

  <!-- Sequence Steps -->

  <!-- Step 1: Upload -->
  <text x="20" y="200" class="step-text">1. Upload</text>

  <path d="M 110 200 L 290 200" class="arrow"/>
  <text x="200" y="195" class="small-text">PUT file.ndjson</text>
  <text x="200" y="210" class="small-text">(3.5-4.5 GB)</text>

  <rect x="280" y="200" width="20" height="60" class="activation"/>

  <path d="M 290 230 L 110 230" class="return-arrow"/>
  <text x="200" y="225" class="small-text">200 OK</text>

  <!-- Step 2: S3 Event -->
  <text x="20" y="290" class="step-text">2. Event</text>

  <path d="M 290 280 L 470 280" class="async-arrow"/>
  <text x="380" y="275" class="small-text">S3 Event: ObjectCreated</text>
  <text x="380" y="290" class="small-text">{bucket, key, size}</text>

  <rect x="460" y="280" width="20" height="60" class="activation"/>

  <!-- Note about async -->
  <rect x="380" y="310" width="180" height="35" class="note-box" rx="3"/>
  <text x="470" y="325" class="note-text" text-anchor="middle">Async event notification</text>
  <text x="470" y="338" class="note-text" text-anchor="middle">Typically &lt;1 second</text>

  <!-- Step 3: Lambda Poll -->
  <text x="20" y="390" class="step-text">3. Poll</text>

  <path d="M 660 380 L 470 380" class="arrow"/>
  <text x="565" y="375" class="small-text">ReceiveMessage</text>
  <text x="565" y="390" class="small-text">(batch=10, wait=60s)</text>

  <rect x="650" y="380" width="20" height="640" class="activation"/>

  <path d="M 470 410 L 660 410" class="return-arrow"/>
  <text x="565" y="405" class="small-text">[10 messages]</text>

  <!-- Step 4: Validate Files -->
  <text x="20" y="460" class="step-text">4. Validate</text>

  <!-- Loop box -->
  <rect x="600" y="440" width="320" height="140" class="note-box" rx="5" style="fill: #e8f5e9;"/>
  <text x="610" y="460" class="note-text" style="font-weight: bold;">LOOP: For each message (10 files)</text>

  <rect x="840" y="480" width="20" height="80" class="activation"/>

  <path d="M 660 490 L 850 490" class="arrow"/>
  <text x="755" y="485" class="small-text">Check size (2.8-4.2 GB)</text>

  <path d="M 660 520 L 850 520" class="arrow"/>
  <text x="755" y="515" class="small-text">PutItem</text>
  <text x="755" y="530" class="small-text">{status: "pending"}</text>

  <path d="M 850 550 L 660 550" class="return-arrow"/>
  <text x="755" y="545" class="small-text">OK</text>

  <!-- Step 5: Query Pending -->
  <text x="20" y="620" class="step-text">5. Batch</text>

  <path d="M 660 610 L 850 610" class="arrow"/>
  <text x="755" y="605" class="small-text">Query pending files</text>
  <text x="755" y="620" class="small-text">WHERE date = today</text>

  <path d="M 850 640 L 660 640" class="return-arrow"/>
  <text x="755" y="635" class="small-text">[100 files ready]</text>

  <!-- Decision box -->
  <rect x="600" y="660" width="180" height="50" class="note-box" rx="3"/>
  <text x="690" y="680" class="note-text" text-anchor="middle">IF count >= 100:</text>
  <text x="690" y="695" class="note-text" text-anchor="middle">Create manifest</text>

  <!-- Step 6: Create Manifest -->
  <text x="20" y="750" class="step-text">6. Manifest</text>

  <rect x="1020" y="740" width="20" height="60" class="activation"/>

  <path d="M 660 750 L 1030 750" class="arrow"/>
  <text x="845" y="745" class="small-text">PutObject manifest.json</text>
  <text x="845" y="760" class="small-text">{fileLocations: [100 URIs]}</text>

  <path d="M 1030 780 L 660 780" class="return-arrow"/>
  <text x="845" y="775" class="small-text">200 OK</text>

  <!-- Step 7: Update Status -->
  <text x="20" y="840" class="step-text">7. Update</text>

  <path d="M 660 830 L 850 830" class="arrow"/>
  <text x="755" y="825" class="small-text">UpdateItem (100 files)</text>
  <text x="755" y="840" class="small-text">{status: "manifested",</text>
  <text x="755" y="855" class="small-text"> manifest_path: ...}</text>

  <path d="M 850 870 L 660 870" class="return-arrow"/>
  <text x="755" y="865" class="small-text">OK</text>

  <!-- Step 8: Delete Messages -->
  <text x="20" y="930" class="step-text">8. Cleanup</text>

  <path d="M 660 920 L 470 920" class="arrow"/>
  <text x="565" y="915" class="small-text">DeleteMessageBatch</text>
  <text x="565" y="930" class="small-text">(10 messages)</text>

  <path d="M 470 950 L 660 950" class="return-arrow"/>
  <text x="565" y="945" class="small-text">OK</text>

  <!-- Note about Lambda end -->
  <rect x="600" y="970" width="200" height="35" class="note-box" rx="3"/>
  <text x="700" y="985" class="note-text" text-anchor="middle">Lambda execution ends</text>
  <text x="700" y="998" class="note-text" text-anchor="middle">Duration: 10-30 seconds</text>

  <!-- Step 9: Trigger Glue -->
  <text x="20" y="1070" class="step-text">9. Trigger</text>

  <path d="M 1030 1060 L 1210 1060" class="async-arrow"/>
  <text x="1120" y="1055" class="small-text">EventBridge trigger</text>
  <text x="1120" y="1070" class="small-text">OR Manual start</text>

  <rect x="1200" y="1060" width="20" height="220" class="activation"/>

  <!-- Step 10: Read Manifest -->
  <text x="20" y="1130" class="step-text">10. Read</text>

  <path d="M 1210 1120 L 1030 1120" class="arrow"/>
  <text x="1120" y="1115" class="small-text">GetObject manifest.json</text>

  <path d="M 1030 1150 L 1210 1150" class="return-arrow"/>
  <text x="1120" y="1145" class="small-text">[100 file paths]</text>

  <!-- Step 11: Process Files -->
  <text x="20" y="1210" class="step-text">11. Process</text>

  <!-- Note about parallel processing -->
  <rect x="1120" y="1180" width="240" height="65" class="note-box" rx="3" style="fill: #e1f5fe;"/>
  <text x="1240" y="1200" class="note-text" text-anchor="middle" style="font-weight: bold;">Parallel PySpark Processing</text>
  <text x="1240" y="1215" class="note-text" text-anchor="middle">20 workers × G.2X</text>
  <text x="1240" y="1228" class="note-text" text-anchor="middle">Read → Parse → Transform</text>
  <text x="1240" y="1241" class="note-text" text-anchor="middle">Duration: 7-10 minutes</text>

  <path d="M 1210 1190 L 290 1190" class="arrow"/>
  <text x="750" y="1185" class="small-text">Read 100 NDJSON files (parallel)</text>

  <path d="M 290 1210 L 1210 1210" class="return-arrow"/>
  <text x="750" y="1205" class="small-text">[400 GB data, 2.1B records]</text>

  <!-- Step 12: Write Output -->
  <text x="20" y="1280" class="step-text">12. Write</text>

  <rect x="1380" y="1260" width="20" height="40" class="activation"/>

  <path d="M 1210 1270 L 1390 1270" class="arrow"/>
  <text x="1300" y="1265" class="small-text">Write Parquet</text>
  <text x="1300" y="1280" class="small-text">(640 files @ 128MB)</text>

  <path d="M 1390 1290 L 1210 1290" class="return-arrow"/>
  <text x="1300" y="1285" class="small-text">200 OK</text>

  <!-- Step 13: Update Completion -->
  <text x="20" y="1340" class="step-text">13. Done</text>

  <path d="M 1210 1330 L 850 1330" class="arrow"/>
  <text x="1030" y="1325" class="small-text">UpdateItem (100 files)</text>
  <text x="1030" y="1340" class="small-text">{status: "completed"}</text>

  <path d="M 850 1350 L 1210 1350" class="return-arrow"/>
  <text x="1030" y="1345" class="small-text">OK</text>

  <!-- Timeline indicators -->
  <text x="1480" y="200" class="small-text" fill="#999">t = 0</text>
  <text x="1480" y="390" class="small-text" fill="#999">t = 1 min</text>
  <text x="1480" y="750" class="small-text" fill="#999">t = 2 min</text>
  <text x="1480" y="1070" class="small-text" fill="#999">t = 5 min</text>
  <text x="1480" y="1350" class="small-text" fill="#999">t = 15 min</text>

  <!-- Summary Box -->
  <rect x="50" y="1380" width="700" height="5" style="fill: #1976d2;"/>

</svg>
